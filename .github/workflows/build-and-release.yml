name: Build and Release

permissions:
  contents: write
  issues: read
  pull-requests: read
  actions: write

on:
  push:
    branches: [ dev ]
    tags:
      - '*'

env:
  BUN_INSTALL_REGISTRY: 'https://registry.npmjs.org/'

jobs:
  build-pipeline:
    name: Build Pipeline
    uses: ./.github/workflows/_build-reusable.yml
    # dev åˆ†æ”¯æˆ–æ­£å¼ tag è§¦å‘æž„å»ºï¼ˆæŽ’é™¤ -dev- tagï¼Œé¿å…é‡å¤æž„å»ºï¼‰
    if: github.ref == 'refs/heads/dev' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref, '-dev-'))
    with:
      matrix: >-
        {"include":[
          {"platform":"macos-arm64","os":"macos-14","command":"node scripts/build-with-builder.js arm64 --mac --arm64","artifact-name":"macos-build-arm64","arch":"arm64"},
          {"platform":"macos-x64","os":"macos-14","command":"node scripts/build-with-builder.js x64 --mac --x64","artifact-name":"macos-build-x64","arch":"x64"},
          {"platform":"windows-x64","os":"windows-2022","command":"node scripts/build-with-builder.js x64 --win --x64","artifact-name":"windows-build-x64","arch":"x64"},
          {"platform":"windows-arm64","os":"windows-2022","command":"node scripts/build-with-builder.js arm64 --win --arm64","artifact-name":"windows-build-arm64","arch":"arm64"},
          {"platform":"linux","os":"ubuntu-latest","command":"bun run dist:linux","artifact-name":"linux-build","arch":"x64,arm64"}
        ]}
    secrets: inherit



  # è‡ªåŠ¨é‡è¯• workflowï¼ˆå½“æž„å»ºå¤±è´¥æ—¶ï¼‰
  auto-retry-workflow:
    name: Auto Retry on Build Failure
    runs-on: ubuntu-latest
    needs: build-pipeline
    # å…³é”®ï¼šåªåœ¨é¦–æ¬¡å¤±è´¥æ—¶è§¦å‘ï¼Œé¿å…æ— é™å¾ªçŽ¯
    if: |
      failure() &&
      github.run_attempt == 1 &&
      (github.event_name == 'push' || github.event_name == 'schedule')

    steps:
      - name: Log retry information
        run: |
          echo "=========================================="
          echo "ðŸ”„ Auto retry triggered (first failure)"
          echo "=========================================="
          echo "Build failed on first attempt, preparing auto retry..."
          echo "Current attempt: ${{ github.run_attempt }}"
          echo "Wait strategy: 5 minutes cooldown before retry"
          echo "=========================================="

      - name: Wait before retry (5 min cooldown)
        run: |
          echo "â³ Waiting 5 minutes before retry..."
          echo "Start: $(date)"
          sleep 300
          echo "End: $(date)"
          echo "Triggering retry..."

      - name: Trigger workflow rerun
        run: |
          echo "ðŸ”„ Triggering full workflow rerun (attempt 2)..."

          # Use re-run API (not rerun-failed-jobs, to avoid loops)
          response=$(curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -w "\n%{http_code}" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/rerun)

          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" = "201" ]; then
            echo ""
            echo "âœ… Retry triggered successfully"
            echo "This will be attempt 2"
            echo "Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo ""
            echo "âŒ Retry trigger failed, HTTP status: $http_code"
            echo "Response:"
            echo "$response" | head -n-1
            exit 1
          fi

  # è‡ªåŠ¨åˆ›å»ºtagï¼ˆä»… dev åˆ†æ”¯æŽ¨é€æ—¶ï¼‰
  create-tag:
    name: Create Tag from Branch
    runs-on: ubuntu-latest
    needs: [ build-pipeline ]
    if: success() && github.ref == 'refs/heads/dev'
    outputs:
      tag_name: ${{ steps.create_tag.outputs.tag_name }}
      is_dev: ${{ steps.create_tag.outputs.is_dev }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Create and push tag
        id: create_tag
        run: |
          VERSION=$(node -p "require('./package.json').version")
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}

          # æ ¹æ®åˆ†æ”¯ç¡®å®š tag æ ¼å¼
          if [ "$BRANCH_NAME" = "dev" ]; then
            TAG_NAME="v${VERSION}-dev-${COMMIT_SHORT}"
            IS_DEV="true"
            echo "ðŸ”§ Development release: $TAG_NAME"
          else
            TAG_NAME="v$VERSION"
            IS_DEV="false"
            echo "ðŸš€ Production release: $TAG_NAME"
          fi

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "is_dev=$IS_DEV" >> $GITHUB_OUTPUT

          # æ£€æŸ¥è¿œç¨‹tagæ˜¯å¦å·²å­˜åœ¨
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME$"; then
            if [ "$IS_DEV" = "false" ]; then
              # Main åˆ†æ”¯ï¼šéœ€è¦é€’å¢žç‰ˆæœ¬å¹¶ä¿®æ”¹ package.json
              echo "âš ï¸ Tag $TAG_NAME already exists, auto-incrementing version..."

              if [[ $VERSION =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                MAJOR=${BASH_REMATCH[1]}
                MINOR=${BASH_REMATCH[2]}
                PATCH=${BASH_REMATCH[3]}
                NEW_PATCH=$((PATCH + 1))
                NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

                echo "ðŸ“ Updating package.json version to $NEW_VERSION"

                # æ›´æ–° package.json ç‰ˆæœ¬å·
                bun pm version $NEW_VERSION

                # é…ç½®gitç”¨æˆ·ä¿¡æ¯
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"

                # æäº¤ç‰ˆæœ¬æ›´æ–°
                git add package.json bun.lock
                git commit -m "chore: bump version to $NEW_VERSION"
                git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
                git push origin $BRANCH_NAME

                # èŽ·å–æ–°çš„ commit ID
                COMMIT_SHORT=$(git rev-parse --short HEAD)
                TAG_NAME="v${NEW_VERSION}-${COMMIT_SHORT}"

                echo "ðŸš€ New tag with updated version: $TAG_NAME"
                echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
              else
                TAG_NAME="v${VERSION}-${COMMIT_SHORT}"
                echo "âš ï¸ Fallback: creating tag with commit ID: $TAG_NAME"
                echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
              fi
            else
              # Dev åˆ†æ”¯ tag å·²å­˜åœ¨åˆ™å¤±è´¥ï¼ˆä¸åº”è¯¥å‘ç”Ÿï¼‰
              echo "âš ï¸ Dev tag $TAG_NAME already exists, this shouldn't happen"
              exit 1
            fi
          fi

          # é…ç½®gitç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æžœå‰é¢æ²¡é…ç½®ï¼‰
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ›å»ºå¹¶æŽ¨é€tag
          echo "Creating tag: $TAG_NAME"
          git tag $TAG_NAME
          git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
          git push origin $TAG_NAME
          echo "âœ… Successfully created and pushed tag: $TAG_NAME"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  # å‘å¸ƒåˆ° GitHub Releases
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [ build-pipeline, create-tag ]
    # Tag æŽ¨é€æ—¶ create-tag ä¼šè¢«è·³è¿‡ï¼Œæ‰€ä»¥éœ€è¦æ£€æŸ¥ä¸¤ç§æƒ…å†µï¼ˆæŽ’é™¤ -dev- tag é¿å…é‡å¤ï¼‰
    if: always() && needs.build-pipeline.result == 'success' && (needs.create-tag.result == 'success' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref, '-dev-')))
    # dev åˆ†æ”¯ä½¿ç”¨ dev-release çŽ¯å¢ƒï¼Œæ­£å¼ tag ä½¿ç”¨ release çŽ¯å¢ƒ
    environment: ${{ needs.create-tag.outputs.is_dev == 'true' && 'dev-release' || 'release' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get version for release
        id: version
        run: |
          # åˆ¤æ–­è§¦å‘æ¥æºï¼šæ­£å¼ tag æŽ¨é€ or dev åˆ†æ”¯
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            # æ­£å¼ Tag æŽ¨é€è§¦å‘ï¼ˆ-dev- tag å·²è¢«æŽ’é™¤ï¼Œä¸ä¼šåˆ°è¾¾è¿™é‡Œï¼‰
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            IS_DEV="false"
            echo "ðŸš€ Creating stable release from tag: $TAG_NAME"
          else
            # dev åˆ†æ”¯è§¦å‘ï¼Œä½¿ç”¨ create-tag job çš„è¾“å‡º
            TAG_NAME="${{ needs.create-tag.outputs.tag_name }}"
            IS_DEV="${{ needs.create-tag.outputs.is_dev }}"
            echo "ðŸ”§ Creating development release: $TAG_NAME"
          fi

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "is_dev=$IS_DEV" >> $GITHUB_OUTPUT

      - name: Download all build artifacts
        uses: actions/download-artifact@v7
        with:
          path: build-artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: ${{ steps.version.outputs.is_dev == 'true' && format('Development Build {0}', steps.version.outputs.tag_name) || steps.version.outputs.tag_name }}
          files: |
            build-artifacts/**/*.exe
            build-artifacts/**/*.msi
            build-artifacts/**/*.dmg
            build-artifacts/**/*.deb
            build-artifacts/**/*.AppImage
            build-artifacts/**/*.zip
            build-artifacts/**/*.yml
            build-artifacts/**/*.blockmap
          generate_release_notes: true
          draft: true
          prerelease: ${{ steps.version.outputs.is_dev == 'true' || contains(steps.version.outputs.tag_name, 'beta') || contains(steps.version.outputs.tag_name, 'alpha') || contains(steps.version.outputs.tag_name, 'rc') }}
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
