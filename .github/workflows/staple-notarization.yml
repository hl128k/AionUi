# macOS 公证票据附加工作流 / macOS Notarization Staple Workflow
#
# 工作原理 / How it works:
# 1. 主构建异步提交公证（不等待），~10分钟完成 / Main build submits notarization async (no wait), completes in ~10min
# 2. 本workflow自动触发，等待苹果公证完成 / This workflow auto-triggers, waits for Apple notarization
# 3. 将公证票据staple到DMG并替换Release / Staples ticket to DMG and replaces in Release
# 4. 超时保护：2小时后自动退出（优雅降级）/ Timeout protection: exits after 2 hours (graceful degradation)
#
# 优势 / Benefits:
# - 主构建不会因苹果延迟超时 / Main build won't timeout due to Apple delays
# - 用户始终获得可用的包 / Users always get usable packages
# - 全自动无需手动干预 / Fully automated, no manual intervention
name: Staple macOS Notarization

on:
  workflow_run:
    workflows: ["Build and Release"]  # 监听主构建workflow / Listen to main build workflow
    types:
      - completed  # 主构建完成时触发 / Trigger when main build completes

jobs:
  staple-and-upload:
    runs-on: macos-latest
    timeout-minutes: 120  # 最多等待2小时，防止无限挂起 / Max 2 hours wait, prevents infinite hanging
    if: ${{ github.event.workflow_run.conclusion == 'success' }}  # 仅当主构建成功时运行 / Only run if main build succeeded

    steps:
      # 检出代码 / Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 下载主构建的产物 / Download artifacts from main build
      - name: Download build artifacts
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          # 从已完成的workflow run下载产物 / Download artifacts from completed workflow run
          gh run download ${{ github.event.workflow_run.id }} \
            --name macos-build \
            --dir ./artifacts \
            --repo ${{ github.repository }}

      # 列出下载的文件 / List downloaded files
      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -lah ./artifacts/

      # 检查是否存在公证提交信息 / Check for notarization submission info
      - name: Check for notarization submission info
        id: check_submission
        run: |
          if [ -f "./artifacts/notarization-submission.json" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            cat ./artifacts/notarization-submission.json
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No notarization submission info found, skipping staple"
          fi

      # 等待苹果公证完成（智能轮询重试）/ Wait for Apple notarization to complete (smart polling with retry)
      - name: Wait for notarization to complete
        if: steps.check_submission.outputs.found == 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
        run: |
          # 从提交信息中获取submission ID / Get submission ID from submission info
          SUBMISSION_ID=$(jq -r '.submissionId' ./artifacts/notarization-submission.json)
          echo "Waiting for notarization submission: $SUBMISSION_ID"
          echo "Start time: $(date)"

          # 智能轮询配置 / Smart polling configuration
          # 0-30分钟: 每3分钟检查 / 0-30min: check every 3min
          # 30-60分钟: 每5分钟检查 / 30-60min: check every 5min
          # 60-120分钟: 每10分钟检查 / 60-120min: check every 10min
          MAX_WAIT_SECONDS=7200  # 2小时 / 2 hours
          START_TIME=$(date +%s)
          ATTEMPT=0

          while true; do
            ATTEMPT=$((ATTEMPT + 1))
            ELAPSED=$(($(date +%s) - START_TIME))
            ELAPSED_MIN=$((ELAPSED / 60))

            echo ""
            echo "=== Attempt #$ATTEMPT (${ELAPSED_MIN}m elapsed) ==="

            # 检查公证状态 / Check notarization status
            STATUS_JSON=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$TEAM_ID" \
              --output-format json 2>&1)

            if [ $? -eq 0 ]; then
              STATUS=$(echo "$STATUS_JSON" | jq -r '.status')
              echo "Current status: $STATUS"

              # 检查是否完成 / Check if completed
              case "$STATUS" in
                "Accepted")
                  echo ""
                  echo "✅ Notarization accepted! (took ${ELAPSED_MIN} minutes)"
                  exit 0
                  ;;
                "Invalid"|"Rejected")
                  echo ""
                  echo "❌ Notarization failed with status: $STATUS"
                  xcrun notarytool log "$SUBMISSION_ID" \
                    --apple-id "$APPLE_ID" \
                    --password "$APPLE_ID_PASSWORD" \
                    --team-id "$TEAM_ID"
                  exit 1
                  ;;
                "In Progress")
                  echo "Still in progress, will retry..."
                  ;;
                *)
                  echo "Unknown status: $STATUS, will retry..."
                  ;;
              esac
            else
              echo "⚠️ Failed to check status, will retry..."
              echo "Error: $STATUS_JSON"
            fi

            # 检查总超时 / Check total timeout
            if [ $ELAPSED -ge $MAX_WAIT_SECONDS ]; then
              echo ""
              echo "⏱️ Timeout reached (120 minutes)"
              echo "Notarization is still in progress but taking too long"
              echo "The signed DMG is still available in the release"
              exit 1
            fi

            # 动态等待间隔 / Dynamic wait interval
            if [ $ELAPSED -lt 1800 ]; then
              # 前30分钟: 每3分钟 / First 30min: every 3min
              WAIT_SECONDS=180
              echo "Next check in 3 minutes..."
            elif [ $ELAPSED -lt 3600 ]; then
              # 30-60分钟: 每5分钟 / 30-60min: every 5min
              WAIT_SECONDS=300
              echo "Next check in 5 minutes..."
            else
              # 60-120分钟: 每10分钟 / 60-120min: every 10min
              WAIT_SECONDS=600
              echo "Next check in 10 minutes..."
            fi

            sleep $WAIT_SECONDS
          done

      # 将公证票据附加到DMG / Staple notarization ticket to DMG
      - name: Staple notarization ticket to DMG
        if: steps.check_submission.outputs.found == 'true'
        run: |
          # 查找DMG文件 / Find the DMG file
          DMG_FILE=$(find ./artifacts -name "*.dmg" -type f | head -n 1)

          if [ -z "$DMG_FILE" ]; then
            echo "No DMG file found in artifacts"
            exit 1
          fi

          echo "Stapling notarization ticket to: $DMG_FILE"
          # 将公证票据staple到DMG（实现离线验证）/ Staple ticket to DMG (enables offline verification)
          xcrun stapler staple "$DMG_FILE"

          # 验证staple是否成功 / Verify staple succeeded
          xcrun stapler validate "$DMG_FILE"
          echo "Stapling completed successfully"

      # 上传stapled后的DMG到Release / Upload stapled DMG to Release
      - name: Upload stapled DMG to Release
        if: steps.check_submission.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          DMG_FILE=$(find ./artifacts -name "*.dmg" -type f | head -n 1)

          # 查找主构建workflow创建的最新draft release / Find the latest draft release created by the Build and Release workflow
          RELEASE_TAG=$(gh release list --repo ${{ github.repository }} --limit 10 --json tagName,isDraft \
            --jq '.[] | select(.isDraft == true) | .tagName' | head -n 1)

          if [ -z "$RELEASE_TAG" ]; then
            echo "No draft release found, skipping upload"
            exit 0
          fi

          echo "Uploading stapled DMG to release: $RELEASE_TAG"

          # 使用--clobber替换已存在的文件 / Upload with --clobber to replace existing file
          gh release upload "$RELEASE_TAG" "$DMG_FILE" --clobber --repo ${{ github.repository }}

          echo "Stapled DMG uploaded successfully"

      # 超时或失败时的清理（优雅降级）/ Cleanup on timeout or failure (graceful degradation)
      - name: Cleanup on timeout or failure
        if: failure() || cancelled()
        run: |
          echo ""
          echo "=========================================="
          echo "⚠️  Staple Workflow Timeout/Failure"
          echo "=========================================="
          echo ""
          echo "Status: Staple workflow did not complete"
          echo "Reason: Either timeout (>120min) or Apple notarization delays"
          echo ""
          echo "✅ Good news: The signed DMG is still fully functional!"
          echo ""
          echo "What this means for users:"
          echo "  • Signed DMG is available in the GitHub Release"
          echo "  • macOS will verify notarization online (works for 99% of users)"
          echo "  • Only offline installations are affected (very rare)"
          echo ""
          echo "Next steps:"
          echo "  1. Check Apple notarization status manually:"
          echo "     xcrun notarytool history --apple-id <ID> --team-id <TEAM>"
          echo "  2. If notarization completed, manually re-run this workflow"
          echo "  3. Or wait - subsequent builds will be much faster (2-3 min)"
          echo ""
          echo "=========================================="
          exit 0  # 不让workflow失败，已签名的包仍可用 / Don't fail the workflow, signed package is still usable
