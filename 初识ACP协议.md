# åˆè¯† ACP åè®®ï¼šAI ç¼–ç åŠ©æ‰‹çš„æ ‡å‡†åŒ–é€šä¿¡åè®®

> ä» MCP åˆ° ACPï¼Œæ¢ç´¢ AI Agent ç”Ÿæ€çš„æ ‡å‡†åŒ–ä¹‹è·¯

## ç›®å½•

- [ä¸€ã€å¼•è¨€ï¼šAI Agent ç”Ÿæ€çš„æ ‡å‡†åŒ–æŒ‘æˆ˜](#ä¸€å¼•è¨€ai-agent-ç”Ÿæ€çš„æ ‡å‡†åŒ–æŒ‘æˆ˜)
- [äºŒã€ä» MCP è¯´èµ·ï¼šç†è§£ AI åè®®çš„æ¼”è¿›](#äºŒä»-mcp-è¯´èµ·ç†è§£-ai-åè®®çš„æ¼”è¿›)
- [ä¸‰ã€ACP æ˜¯ä»€ä¹ˆï¼Ÿ](#ä¸‰acp-æ˜¯ä»€ä¹ˆ)
- [å››ã€ACP æ ¸å¿ƒæ¶æ„è®¾è®¡](#å››acp-æ ¸å¿ƒæ¶æ„è®¾è®¡)
- [äº”ã€ACP åè®®è¯¦è§£](#äº”acp-åè®®è¯¦è§£)
- [å…­ã€ACP å®æˆ˜ï¼šä»ä»£ç çœ‹å®ç°](#å…­acp-å®æˆ˜ä»ä»£ç çœ‹å®ç°)
- [ä¸ƒã€ACP vs MCPï¼šä¸¤ä¸ªåè®®çš„å¯¹æ¯”ä¸äº’è¡¥](#ä¸ƒacp-vs-mcpä¸¤ä¸ªåè®®çš„å¯¹æ¯”ä¸äº’è¡¥)
- [å…«ã€ç”Ÿæ€ç³»ç»Ÿä¸å®é™…åº”ç”¨](#å…«ç”Ÿæ€ç³»ç»Ÿä¸å®é™…åº”ç”¨)
- [ä¹ã€æœ€ä½³å®è·µä¸å®‰å…¨è€ƒé‡](#ä¹æœ€ä½³å®è·µä¸å®‰å…¨è€ƒé‡)
- [åã€æœªæ¥å±•æœ›](#åæœªæ¥å±•æœ›)

---

## ä¸€ã€å¼•è¨€ï¼šAI Agent ç”Ÿæ€çš„æ ‡å‡†åŒ–æŒ‘æˆ˜

### 1.1 å½“å‰ AI å¼€å‘å·¥å…·é¢ä¸´çš„é—®é¢˜

åœ¨ AI è¾…åŠ©ç¼–ç¨‹å·¥å…·å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å„ç§å¼ºå¤§çš„ AI ç¼–ç åŠ©æ‰‹ï¼š

- **GitHub Copilot**ï¼šå¾®è½¯çš„ AI ä»£ç è¡¥å…¨å·¥å…·
- **Cursor**ï¼šAI é©±åŠ¨çš„ä»£ç ç¼–è¾‘å™¨
- **Claude Code**ï¼šAnthropic çš„æ™ºèƒ½ç¼–ç åŠ©æ‰‹
- **Codex CLI**ï¼šOpenAI çš„å‘½ä»¤è¡Œç¼–ç å·¥å…·
- **Gemini Code Assist**ï¼šGoogle çš„ç¼–ç åŠ©æ‰‹

ç„¶è€Œï¼Œè¿™äº›å·¥å…·ä¹‹é—´å­˜åœ¨ä¸¥é‡çš„**äº’æ“ä½œæ€§é—®é¢˜**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç°çŠ¶ï¼šä¿¡æ¯å­¤å²›                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ VS Code â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚ Copilot â”‚       â”‚ Claude  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â•³                                    â•³        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   Zed   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  Agent  â”‚       â”‚ Gemini  â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â•³                                    â•³        â”‚
â”‚   æ¯ä¸ªç¼–è¾‘å™¨åªèƒ½ç”¨ç‰¹å®šçš„ Agent                       â”‚
â”‚   ç”¨æˆ·æ— æ³•è‡ªç”±é€‰æ‹©å’Œåˆ‡æ¢                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæŒ‘æˆ˜ï¼š**

1. **ç¼–è¾‘å™¨é”å®š**ï¼šç”¨æˆ·å¿…é¡»ä¸ºç‰¹å®š AI Agent åˆ‡æ¢ç¼–è¾‘å™¨
2. **é‡å¤å¼€å‘**ï¼šæ¯ä¸ªç¼–è¾‘å™¨éƒ½è¦ä¸ºæ¯ä¸ª Agent å•ç‹¬å¼€å‘é›†æˆ
3. **ç”¨æˆ·ä½“éªŒå‰²è£‚**ï¼šä¸åŒ Agent çš„äº¤äº’æ–¹å¼å®Œå…¨ä¸åŒ
4. **ç”Ÿæ€ç¢ç‰‡åŒ–**ï¼šéš¾ä»¥å½¢æˆç»Ÿä¸€çš„å¼€å‘è€…ç¤¾åŒº

### 1.2 æ ‡å‡†åŒ–åè®®çš„ä»·å€¼

æ­£å¦‚ **Language Server Protocol (LSP)** å°†è¯­è¨€æ™ºèƒ½ä»å•ä¸€ IDE ä¸­è§£æ”¾å‡ºæ¥ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç±»ä¼¼çš„æ ‡å‡†æ¥è§£å†³ AI Agent çš„äº’æ“ä½œæ€§é—®é¢˜ã€‚

è¿™å°±æ˜¯ **Agent Client Protocol (ACP)** è¯ç”Ÿçš„èƒŒæ™¯ã€‚

---

## äºŒã€ä» MCP è¯´èµ·ï¼šç†è§£ AI åè®®çš„æ¼”è¿›

### 2.1 ä»€ä¹ˆæ˜¯ MCPï¼Ÿ

åœ¨ä»‹ç» ACP ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆäº†è§£ **MCP (Model Context Protocol)**ã€‚

**MCP** æ˜¯ Anthropic æ¨å‡ºçš„å¼€æºæ ‡å‡†åè®®ï¼Œç”¨äºè¿æ¥ **AI æ¨¡å‹**ä¸**å¤–éƒ¨ç³»ç»Ÿ**ï¼ˆæ•°æ®æºã€å·¥å…·ã€API ç­‰ï¼‰ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MCP æ¶æ„å›¾                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   AI Model   â”‚  (Claude, GPT, etc.) â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                               â”‚
â”‚         â”‚ MCP Protocol                  â”‚
â”‚         â”‚                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚   MCP Servers       â”‚             â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚    â”‚ â€¢ Database Server   â”‚             â”‚
â”‚    â”‚ â€¢ File System       â”‚             â”‚
â”‚    â”‚ â€¢ API Services      â”‚             â”‚
â”‚    â”‚ â€¢ Knowledge Base    â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**MCP çš„ä¸‰å¤§æ ¸å¿ƒåŸè¯­ï¼š**

#### 1. Resourcesï¼ˆèµ„æºï¼‰

ç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„åªè¯»æ•°æ®æºï¼Œä¾› AI æ¨¡å‹è¯»å–ä¸Šä¸‹æ–‡ã€‚

```typescript
// MCP Resource ç¤ºä¾‹
{
  "uri": "file:///workspace/README.md",
  "name": "é¡¹ç›®æ–‡æ¡£",
  "mimeType": "text/markdown",
  "description": "é¡¹ç›®éœ€æ±‚å’Œæ¶æ„æ–‡æ¡£"
}
```

#### 2. Toolsï¼ˆå·¥å…·ï¼‰

AI æ¨¡å‹å¯è°ƒç”¨çš„å¯æ‰§è¡Œå‡½æ•°ã€‚

```python
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("code-tools")

@mcp.tool()
async def run_tests(test_file: str) -> str:
    """è¿è¡ŒæŒ‡å®šçš„æµ‹è¯•æ–‡ä»¶"""
    result = subprocess.run(['pytest', test_file], capture_output=True)
    return result.stdout.decode()
```

#### 3. Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰

é¢„ç¼–å†™çš„ä»»åŠ¡æ¨¡æ¿ï¼Œæ ‡å‡†åŒ–å¸¸è§æ“ä½œã€‚

```typescript
{
  "name": "code_review",
  "description": "ä»£ç å®¡æŸ¥æç¤ºæ¨¡æ¿",
  "arguments": [
    {
      "name": "language",
      "description": "ç¼–ç¨‹è¯­è¨€",
      "required": true
    }
  ]
}
```

### 2.2 MCP çš„å±€é™æ€§

è™½ç„¶ MCP è§£å†³äº† AI æ¨¡å‹ä¸å·¥å…·çš„è¿æ¥é—®é¢˜ï¼Œä½†å®ƒ**å¹¶ä¸è§£å†³ç¼–è¾‘å™¨ä¸ AI Agent çš„é€šä¿¡é—®é¢˜**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MCP çš„ä½œç”¨èŒƒå›´                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                            â”‚
â”‚  ç¼–è¾‘å™¨ â”€â”€â“â”€â”€â–¶ AI Agent â”€â”€âœ“ MCPâ”€â”€â–¶ å·¥å…·   â”‚
â”‚   (Zed)         (Claude)         (DB/API) â”‚
â”‚                                            â”‚
â”‚  âŒ æ²¡æœ‰æ ‡å‡†åè®®  âœ… æœ‰ MCP åè®®            â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™å°±æ˜¯ **ACP** è¦è§£å†³çš„é—®é¢˜ã€‚

---

## ä¸‰ã€ACP æ˜¯ä»€ä¹ˆï¼Ÿ

### 3.1 å®šä¹‰

**Agent Client Protocol (ACP)** æ˜¯ä¸€ä¸ª**å¼€æ”¾æ ‡å‡†åè®®**ï¼Œç”¨äºè§„èŒƒ**ä»£ç ç¼–è¾‘å™¨**ä¸ **AI ç¼–ç åŠ©æ‰‹ï¼ˆCoding Agentï¼‰**ä¹‹é—´çš„é€šä¿¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ACP å®Œæ•´æ¶æ„å›¾                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Editor  â”‚â—€â”€â”€â”€â”€ ACP â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Agent   â”‚   â”‚
â”‚  â”‚  (Zed)   â”‚                  â”‚ (Claude) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚          â”‚
â”‚                                      â”‚ MCP      â”‚
â”‚                                      â”‚          â”‚
â”‚                                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”‚
â”‚                                 â”‚   Tools  â”‚   â”‚
â”‚                                 â”‚ Resourcesâ”‚   â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç†å¿µï¼š**

> å°±åƒ USB-C æ¥å£å¯ä»¥è¿æ¥ä»»ä½•è®¾å¤‡ï¼ŒACP è®©ä»»ä½•ç¼–è¾‘å™¨éƒ½èƒ½ä½¿ç”¨ä»»ä½• AI Agentã€‚

### 3.2 è®¾è®¡ç›®æ ‡

| ç›®æ ‡         | è¯´æ˜                                    |
| ------------ | --------------------------------------- |
| **é€šç”¨æ€§**   | ä»»ä½•ç¼–è¾‘å™¨éƒ½èƒ½é›†æˆä»»ä½•ç¬¦åˆ ACP çš„ Agent |
| **éšç§ä¼˜å…ˆ** | æœ¬åœ°é€šä¿¡ï¼Œä¸ç»è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨            |
| **å¼€æºå¼€æ”¾** | Apache 2.0 è®¸å¯è¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥å®ç°     |
| **å¯æ‰©å±•æ€§** | æ”¯æŒæœªæ¥çš„æ–°åŠŸèƒ½å’Œæ–°åœºæ™¯                |

### 3.3 ä¸ LSP çš„ç±»æ¯”

å¦‚æœä½ ç†Ÿæ‚‰ **Language Server Protocol (LSP)**ï¼Œå¯ä»¥è¿™æ ·ç†è§£ ACPï¼š

```
LSP ä¹‹äºè¯­è¨€æ™ºèƒ½ = ACP ä¹‹äº AI ç¼–ç åŠ©æ‰‹

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LSP æ¨¡å¼                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  ä»»æ„ç¼–è¾‘å™¨ â—€â”€â”€â”€ LSP â”€â”€â”€â–¶ ä»»æ„è¯­è¨€æœåŠ¡å™¨ â”‚
â”‚  (VS Code)              (TypeScript)  â”‚
â”‚  (Vim)                  (Python)      â”‚
â”‚  (Emacs)                (Go)          â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ACP æ¨¡å¼                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  ä»»æ„ç¼–è¾‘å™¨ â—€â”€â”€â”€ ACP â”€â”€â”€â–¶ ä»»æ„ AI Agent â”‚
â”‚  (Zed)                  (Claude Code) â”‚
â”‚  (Neovim)               (Gemini)      â”‚
â”‚  (JetBrains)            (Codex)       â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ACP æ ¸å¿ƒæ¶æ„è®¾è®¡

### 4.1 é€šä¿¡æ¨¡å‹

ACP é‡‡ç”¨ **JSON-RPC 2.0** åè®®ï¼ŒåŸºäº **stdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰**è¿›è¡Œé€šä¿¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ACP é€šä¿¡æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚   Editor     â”‚                          â”‚
â”‚  â”‚  (ä¸»è¿›ç¨‹)     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”‚                                   â”‚
â”‚         â”‚ spawn()                           â”‚
â”‚         â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚    Agent     â”‚                          â”‚
â”‚  â”‚  (å­è¿›ç¨‹)     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                             â”‚
â”‚  é€šä¿¡æ–¹å¼ï¼š                                  â”‚
â”‚  â€¢ Editor å†™å…¥ Agent çš„ stdin              â”‚
â”‚  â€¢ Agent å†™å…¥ stdout è¿”å›ç»™ Editor          â”‚
â”‚  â€¢ æ¶ˆæ¯æ ¼å¼ï¼šJSON-RPC 2.0                   â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿ï¼š**

1. **ç®€å•é«˜æ•ˆ**ï¼šæ— éœ€ç½‘ç»œå±‚ï¼Œç›´æ¥è¿›ç¨‹é—´é€šä¿¡
2. **éšç§å®‰å…¨**ï¼šæ‰€æœ‰æ•°æ®éƒ½åœ¨æœ¬åœ°ï¼Œä¸ç»è¿‡å¤–éƒ¨æœåŠ¡å™¨
3. **è·¨å¹³å°**ï¼šstdin/stdout æ˜¯æ‰€æœ‰æ“ä½œç³»ç»Ÿçš„æ ‡å‡†

### 4.2 åè®®å±‚æ¬¡

ACP åˆ†ä¸ºä¸¤ä¸ªæ ¸å¿ƒå±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åè®®åˆ†å±‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   åº”ç”¨å±‚ (Application Layer)    â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ Session Management           â”‚   â”‚
â”‚  â”‚ â€¢ Tool Calls                   â”‚   â”‚
â”‚  â”‚ â€¢ Permission Requests          â”‚   â”‚
â”‚  â”‚ â€¢ File Operations              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–²                         â”‚
â”‚               â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   åè®®å±‚ (Protocol Layer)       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ JSON-RPC 2.0                 â”‚   â”‚
â”‚  â”‚ â€¢ Request/Response             â”‚   â”‚
â”‚  â”‚ â€¢ Notifications                â”‚   â”‚
â”‚  â”‚ â€¢ Error Handling               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â–²                         â”‚
â”‚               â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   ä¼ è¾“å±‚ (Transport Layer)      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ â€¢ stdio (stdin/stdout)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ¶ˆæ¯ç±»å‹

ACP æ”¯æŒä¸‰ç§æ¶ˆæ¯ç±»å‹ï¼š

#### 1. Requestï¼ˆè¯·æ±‚ï¼‰

å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼ŒæœŸå¾…å“åº”ã€‚

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {
    "protocolVersion": "0.1.0",
    "clientInfo": {
      "name": "Zed",
      "version": "0.158.0"
    }
  }
}
```

#### 2. Responseï¼ˆå“åº”ï¼‰

æœåŠ¡å™¨å¯¹è¯·æ±‚çš„å“åº”ã€‚

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "0.1.0",
    "serverInfo": {
      "name": "Claude Code",
      "version": "1.0.0"
    },
    "capabilities": {
      "tools": true,
      "resources": true
    }
  }
}
```

#### 3. Notificationï¼ˆé€šçŸ¥ï¼‰

å•å‘æ¶ˆæ¯ï¼Œä¸æœŸå¾…å“åº”ã€‚

```json
{
  "jsonrpc": "2.0",
  "method": "session/update",
  "params": {
    "sessionId": "session-123",
    "update": {
      "sessionUpdate": "agent_message_chunk",
      "content": {
        "type": "text",
        "text": "æ­£åœ¨åˆ†æä»£ç ..."
      }
    }
  }
}
```

---

## äº”ã€ACP åè®®è¯¦è§£

### 5.1 æ ¸å¿ƒæ–¹æ³•

ACP å®šä¹‰äº†ä¸€ç³»åˆ—æ ‡å‡†æ–¹æ³•ï¼š

| æ–¹æ³•                         | ç±»å‹         | è¯´æ˜                     |
| ---------------------------- | ------------ | ------------------------ |
| `initialize`                 | Request      | åˆå§‹åŒ–è¿æ¥ï¼Œäº¤æ¢èƒ½åŠ›ä¿¡æ¯ |
| `authenticate`               | Request      | èº«ä»½éªŒè¯ï¼ˆå¯é€‰ï¼‰         |
| `session/new`                | Request      | åˆ›å»ºæ–°çš„å¯¹è¯ä¼šè¯         |
| `session/prompt`             | Request      | å‘ Agent å‘é€ç”¨æˆ·æ¶ˆæ¯    |
| `session/update`             | Notification | Agent æ¨é€ä¼šè¯æ›´æ–°       |
| `session/request_permission` | Notification | Agent è¯·æ±‚ç”¨æˆ·æƒé™       |
| `fs/read_text_file`          | Request      | è¯»å–æ–‡ä»¶å†…å®¹             |
| `fs/write_text_file`         | Request      | å†™å…¥æ–‡ä»¶å†…å®¹             |
| `end_turn`                   | Notification | Agent å®Œæˆä¸€è½®å“åº”       |

### 5.2 åˆå§‹åŒ–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ACP åˆå§‹åŒ–åºåˆ—å›¾                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                â”‚
â”‚  Editor                          Agent         â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â”€â”€â”€â”€ spawn(agent-cli) â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â”€â”€â”€â”€ initialize request â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚
â”‚    â”‚     {clientInfo, version}     â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â—€â”€â”€â”€ initialize response â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚    â”‚     {serverInfo, capabilities}â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â”€â”€â”€â”€ authenticate (optional) â”€â–¶â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â—€â”€â”€â”€ auth response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â”€â”€â”€â”€ session/new â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚
â”‚    â”‚     {cwd, mcpServers}         â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â”‚â—€â”€â”€â”€ session created â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚
â”‚    â”‚     {sessionId}               â”‚           â”‚
â”‚    â”‚                               â”‚           â”‚
â”‚    â— è¿æ¥å»ºç«‹å®Œæˆï¼Œå¯ä»¥å¼€å§‹å¯¹è¯     â—           â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†è¯´æ˜ï¼š**

#### æ­¥éª¤ 1ï¼šå¯åŠ¨ Agent è¿›ç¨‹

```typescript
// AionUi é¡¹ç›®ä¸­çš„å®é™…ä»£ç 
// src/agent/acp/AcpConnection.ts

async connect(backend: AcpBackend, cliPath?: string, workingDir?: string) {
  const command = cliPath || this.getDefaultCliPath(backend);

  // ä½¿ç”¨ spawn å¯åŠ¨ Agent å­è¿›ç¨‹
  this.agentProcess = spawn(command, [], {
    cwd: workingDir,
    env: process.env,
  });

  // ç›‘å¬ stdoutï¼ˆAgent çš„è¾“å‡ºï¼‰
  this.agentProcess.stdout.on('data', this.handleStdout.bind(this));

  // ç›‘å¬ stderrï¼ˆAgent çš„æ—¥å¿—ï¼‰
  this.agentProcess.stderr.on('data', this.handleStderr.bind(this));

  // åˆå§‹åŒ–åè®®
  await this.initialize();
}
```

#### æ­¥éª¤ 2ï¼šå‘é€åˆå§‹åŒ–è¯·æ±‚

```typescript
private async initialize(): Promise<AcpResponse> {
  return await this.sendRequest('initialize', {
    protocolVersion: '0.1.0',
    clientInfo: {
      name: 'AionUi',
      version: '1.0.0',
    },
  });
}
```

#### æ­¥éª¤ 3ï¼šæ¥æ”¶èƒ½åŠ›ä¿¡æ¯

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "protocolVersion": "0.1.0",
    "serverInfo": {
      "name": "Claude Code",
      "version": "1.0.128"
    },
    "capabilities": {
      "tools": true,
      "resources": true,
      "streaming": false
    }
  }
}
```

### 5.3 ä¼šè¯æ›´æ–°ç±»å‹

ACP å®šä¹‰äº†ä¸°å¯Œçš„ä¼šè¯æ›´æ–°ç±»å‹ï¼Œè®©ç¼–è¾‘å™¨èƒ½å®æ—¶æ˜¾ç¤º Agent çš„æ€è€ƒå’Œæ“ä½œè¿‡ç¨‹ã€‚

```typescript
// AionUi é¡¹ç›®ä¸­çš„ç±»å‹å®šä¹‰
// src/types/acpTypes.ts

export type AcpSessionUpdate =
  | AgentMessageChunkUpdate // Agent æ¶ˆæ¯å—
  | AgentThoughtChunkUpdate // Agent æ€è€ƒè¿‡ç¨‹
  | ToolCallUpdate // å·¥å…·è°ƒç”¨
  | ToolCallUpdateStatus // å·¥å…·çŠ¶æ€æ›´æ–°
  | PlanUpdate // ä»»åŠ¡è®¡åˆ’
  | AvailableCommandsUpdate // å¯ç”¨å‘½ä»¤åˆ—è¡¨
  | UserMessageChunkUpdate; // ç”¨æˆ·æ¶ˆæ¯å—
```

#### 1. Agent æ¶ˆæ¯å—ï¼ˆAgentMessageChunkUpdateï¼‰

Agent å‘ç”¨æˆ·å‘é€çš„æ™®é€šæ¶ˆæ¯ã€‚

```json
{
  "method": "session/update",
  "params": {
    "sessionId": "sess-123",
    "update": {
      "sessionUpdate": "agent_message_chunk",
      "content": {
        "type": "text",
        "text": "æˆ‘å·²ç»åˆ†æäº†ä½ çš„ä»£ç ï¼Œå‘ç°äº†ä»¥ä¸‹é—®é¢˜..."
      }
    }
  }
}
```

#### 2. Agent æ€è€ƒè¿‡ç¨‹ï¼ˆAgentThoughtChunkUpdateï¼‰

Agent çš„å†…éƒ¨æ€è€ƒè¿‡ç¨‹ï¼Œç±»ä¼¼ "æ€ç»´é“¾"ã€‚

```json
{
  "method": "session/update",
  "params": {
    "sessionId": "sess-123",
    "update": {
      "sessionUpdate": "agent_thought_chunk",
      "content": {
        "type": "text",
        "text": "é¦–å…ˆï¼Œæˆ‘éœ€è¦æ£€æŸ¥ package.json ä¸­çš„ä¾èµ–ç‰ˆæœ¬..."
      }
    }
  }
}
```

#### 3. å·¥å…·è°ƒç”¨ï¼ˆToolCallUpdateï¼‰

æœ€é‡è¦çš„æ›´æ–°ç±»å‹ï¼Œè¡¨ç¤º Agent è¦æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚

```typescript
interface ToolCallUpdate {
  sessionUpdate: 'tool_call';
  toolCallId: string; // å·¥å…·è°ƒç”¨å”¯ä¸€ ID
  status: 'pending' | 'in_progress' | 'completed' | 'failed';
  title: string; // æ“ä½œæè¿°
  kind: 'read' | 'edit' | 'execute'; // æ“ä½œç±»å‹
  rawInput?: any; // åŸå§‹è¾“å…¥å‚æ•°
  content?: Array<{
    type: 'content' | 'diff';
    // ... å†…å®¹è¯¦æƒ…
  }>;
  locations?: Array<{
    path: string; // å—å½±å“çš„æ–‡ä»¶è·¯å¾„
  }>;
}
```

**ç¤ºä¾‹ï¼šè¯»å–æ–‡ä»¶**

```json
{
  "method": "session/update",
  "params": {
    "sessionId": "sess-123",
    "update": {
      "sessionUpdate": "tool_call",
      "toolCallId": "tool-001",
      "status": "pending",
      "title": "è¯»å– src/index.ts",
      "kind": "read",
      "locations": [{ "path": "/workspace/src/index.ts" }]
    }
  }
}
```

**ç¤ºä¾‹ï¼šç¼–è¾‘æ–‡ä»¶**

```json
{
  "method": "session/update",
  "params": {
    "sessionId": "sess-123",
    "update": {
      "sessionUpdate": "tool_call",
      "toolCallId": "tool-002",
      "status": "in_progress",
      "title": "ä¿®å¤ TypeScript ç±»å‹é”™è¯¯",
      "kind": "edit",
      "content": [
        {
          "type": "diff",
          "diff": "--- a/src/index.ts\n+++ b/src/index.ts\n@@ -10,7 +10,7 @@\n-function add(a, b) {\n+function add(a: number, b: number): number {\n   return a + b;\n }"
        }
      ],
      "locations": [{ "path": "/workspace/src/index.ts" }]
    }
  }
}
```

#### 4. è®¡åˆ’æ›´æ–°ï¼ˆPlanUpdateï¼‰

Agent çš„ä»»åŠ¡æ‰§è¡Œè®¡åˆ’ã€‚

```json
{
  "method": "session/update",
  "params": {
    "sessionId": "sess-123",
    "update": {
      "sessionUpdate": "plan",
      "entries": [
        {
          "content": "åˆ†æç°æœ‰ä»£ç ç»“æ„",
          "status": "completed"
        },
        {
          "content": "è¯†åˆ«ç±»å‹é”™è¯¯ä½ç½®",
          "status": "in_progress"
        },
        {
          "content": "ä¿®å¤ç±»å‹å®šä¹‰",
          "status": "pending",
          "priority": "high"
        },
        {
          "content": "è¿è¡Œ TypeScript ç¼–è¯‘æ£€æŸ¥",
          "status": "pending"
        }
      ]
    }
  }
}
```

### 5.4 æƒé™è¯·æ±‚æœºåˆ¶

ACP çš„ä¸€ä¸ªé‡è¦å®‰å…¨ç‰¹æ€§æ˜¯**æƒé™è¯·æ±‚æœºåˆ¶**ã€‚Agent åœ¨æ‰§è¡Œæ•æ„Ÿæ“ä½œå‰å¿…é¡»è·å¾—ç”¨æˆ·è®¸å¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æƒé™è¯·æ±‚æµç¨‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  Agent                          Editor       â”‚
â”‚    â”‚                               â”‚         â”‚
â”‚    â”‚â”€â”€â”€ session/request_permission â”€â”€â–¶â”‚     â”‚
â”‚    â”‚    {toolCall, options}        â”‚         â”‚
â”‚    â”‚                               â”‚         â”‚
â”‚    â”‚                           [æ˜¾ç¤ºå¯¹è¯æ¡†]   â”‚
â”‚    â”‚                           ç”¨æˆ·é€‰æ‹©ï¼š     â”‚
â”‚    â”‚                           â€¢ ä»…æ­¤ä¸€æ¬¡å…è®¸  â”‚
â”‚    â”‚                           â€¢ å§‹ç»ˆå…è®¸     â”‚
â”‚    â”‚                           â€¢ æ‹’ç»        â”‚
â”‚    â”‚                               â”‚         â”‚
â”‚    â”‚â—€â”€â”€â”€ permission response â”€â”€â”€â”€â”€â”€â”‚         â”‚
â”‚    â”‚     {optionId: "allow_once"}  â”‚         â”‚
â”‚    â”‚                               â”‚         â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æƒé™è¯·æ±‚æ¶ˆæ¯æ ¼å¼ï¼š**

```typescript
interface AcpPermissionRequest {
  sessionId: string;
  options: Array<{
    optionId: string;
    name: string;
    kind: 'allow_once' | 'allow_always' | 'reject_once' | 'reject_always';
  }>;
  toolCall: {
    toolCallId: string;
    title: string;
    kind: 'read' | 'edit' | 'execute';
    content?: Array<any>;
    locations?: Array<{ path: string }>;
  };
}
```

**ç¤ºä¾‹ï¼šè¯·æ±‚å†™å…¥æ–‡ä»¶æƒé™**

```json
{
  "method": "session/request_permission",
  "params": {
    "sessionId": "sess-123",
    "options": [
      {
        "optionId": "allow_once",
        "name": "ä»…æ­¤ä¸€æ¬¡å…è®¸",
        "kind": "allow_once"
      },
      {
        "optionId": "allow_always",
        "name": "å§‹ç»ˆå…è®¸å¯¹æ­¤æ–‡ä»¶çš„å†™å…¥",
        "kind": "allow_always"
      },
      {
        "optionId": "reject",
        "name": "æ‹’ç»",
        "kind": "reject_once"
      }
    ],
    "toolCall": {
      "toolCallId": "tool-003",
      "title": "å†™å…¥æ–‡ä»¶ src/config.ts",
      "kind": "edit",
      "locations": [{ "path": "/workspace/src/config.ts" }],
      "content": [
        {
          "type": "diff",
          "diff": "... (ä¿®æ”¹å†…å®¹) ..."
        }
      ]
    }
  }
}
```

**AionUi ä¸­çš„æƒé™ UI å®ç°ï¼š**

```typescript
// src/renderer/messages/acp/MessageAcpPermission.tsx

const MessageAcpPermission: React.FC<Props> = ({ message }) => {
  const handleConfirm = async (optionId: string) => {
    // è°ƒç”¨ IPC Bridge ç¡®è®¤æƒé™
    await ipcBridge.acpConversation.confirmMessage.invoke({
      confirmKey: message.confirmKey,
      msg_id: message.msg_id,
      conversation_id: message.conversation_id,
      callId: message.toolCall.toolCallId,
    });
  };

  return (
    <div className="permission-dialog">
      <h3>{message.toolCall.title}</h3>
      <div className="options">
        {message.options.map(option => (
          <button key={option.optionId} onClick={() => handleConfirm(option.optionId)}>
            {option.name}
          </button>
        ))}
      </div>
    </div>
  );
};
```

---

## å…­ã€ACP å®æˆ˜ï¼šä»ä»£ç çœ‹å®ç°

è®©æˆ‘ä»¬é€šè¿‡ AionUi é¡¹ç›®çš„å®é™…ä»£ç ï¼Œæ·±å…¥ç†è§£ ACP çš„å®ç°ç»†èŠ‚ã€‚

### 6.1 AcpConnection ç±»ï¼šåè®®é€šä¿¡å±‚

è¿™æ˜¯ ACP å®¢æˆ·ç«¯çš„æ ¸å¿ƒå®ç°ï¼Œè´Ÿè´£ä¸ Agent è¿›ç¨‹çš„é€šä¿¡ã€‚

**å®Œæ•´å®ç°æµç¨‹ï¼š**

```typescript
// src/agent/acp/AcpConnection.ts (605 è¡Œ)

export class AcpConnection {
  private agentProcess: ChildProcess | null = null;
  private pendingRequests: Map<number, PendingRequest> = new Map();
  private requestIdCounter = 0;

  // äº‹ä»¶å›è°ƒ
  public onSessionUpdate?: (data: AcpSessionUpdate) => void;
  public onPermissionRequest?: (data: AcpPermissionRequest) => Promise<{ optionId: string }>;
  public onEndTurn?: () => void;
  public onFileOperation?: (operation: any) => void;

  /**
   * è¿æ¥åˆ° Agent
   */
  async connect(backend: AcpBackend, cliPath?: string, workingDir?: string) {
    const command = cliPath || this.getDefaultCliPath(backend);

    // å¯åŠ¨ Agent å­è¿›ç¨‹
    this.agentProcess = spawn(command, [], {
      cwd: workingDir,
      env: process.env,
      stdio: ['pipe', 'pipe', 'pipe'], // stdin, stdout, stderr
    });

    // ç›‘å¬è¾“å‡º
    this.agentProcess.stdout.on('data', this.handleStdout.bind(this));
    this.agentProcess.stderr.on('data', this.handleStderr.bind(this));

    // åˆå§‹åŒ–åè®®
    await this.initialize();
  }

  /**
   * å‘é€ JSON-RPC è¯·æ±‚
   */
  private async sendRequest(method: string, params: any, timeout = 60000): Promise<AcpResponse> {
    const id = ++this.requestIdCounter;

    const request: AcpRequest = {
      jsonrpc: JSONRPC_VERSION,
      id,
      method,
      params,
    };

    // åˆ›å»º Promiseï¼Œç­‰å¾…å“åº”
    return new Promise((resolve, reject) => {
      const timer = setTimeout(() => {
        this.pendingRequests.delete(id);
        reject(new Error(`Request ${method} timeout after ${timeout}ms`));
      }, timeout);

      this.pendingRequests.set(id, { resolve, reject, timer });

      // å†™å…¥ Agent çš„ stdin
      const message = JSON.stringify(request) + '\n';
      this.agentProcess.stdin.write(message);
    });
  }

  /**
   * å¤„ç† Agent çš„è¾“å‡º
   */
  private handleStdout(data: Buffer) {
    const lines = data
      .toString()
      .split('\n')
      .filter((line) => line.trim());

    for (const line of lines) {
      try {
        const message = JSON.parse(line);

        if ('id' in message && 'result' in message) {
          // Response: åŒ¹é…è¯·æ±‚å¹¶ resolve
          const pending = this.pendingRequests.get(message.id);
          if (pending) {
            clearTimeout(pending.timer);
            pending.resolve(message);
            this.pendingRequests.delete(message.id);
          }
        } else if ('method' in message) {
          // Notification: è§¦å‘å›è°ƒ
          this.handleNotification(message);
        }
      } catch (error) {
        console.error('Failed to parse message:', line, error);
      }
    }
  }

  /**
   * å¤„ç†é€šçŸ¥æ¶ˆæ¯
   */
  private handleNotification(notification: AcpNotification) {
    const { method, params } = notification;

    switch (method) {
      case 'session/update':
        if (this.onSessionUpdate) {
          this.onSessionUpdate(params.update);
        }
        break;

      case 'session/request_permission':
        if (this.onPermissionRequest) {
          this.handlePermissionRequest(params);
        }
        break;

      case 'end_turn':
        if (this.onEndTurn) {
          this.onEndTurn();
        }
        break;

      case 'fs/read_text_file':
        this.handleReadOperation(params);
        break;

      case 'fs/write_text_file':
        this.handleWriteOperation(params);
        break;
    }
  }

  /**
   * åˆ›å»ºæ–°ä¼šè¯
   */
  async newSession(cwd: string): Promise<AcpResponse> {
    return await this.sendRequest(
      'session/new',
      {
        cwd,
        mcpServers: [], // å¯é…ç½® MCP æœåŠ¡å™¨
      },
      120000
    ); // 120 ç§’è¶…æ—¶
  }

  /**
   * å‘é€ç”¨æˆ·æ¶ˆæ¯
   */
  async sendPrompt(prompt: string): Promise<AcpResponse> {
    return await this.sendRequest(
      'session/prompt',
      {
        prompt,
      },
      120000
    );
  }

  /**
   * æ–­å¼€è¿æ¥
   */
  async disconnect() {
    if (this.agentProcess) {
      this.agentProcess.kill();
      this.agentProcess = null;
    }
    this.pendingRequests.clear();
  }
}
```

### 6.2 AcpAgent ç±»ï¼šä¸šåŠ¡é€»è¾‘å±‚

```typescript
// src/agent/acp/index.ts (607 è¡Œ)

export class AcpAgent {
  private connection: AcpConnection;
  private sessionId: string | null = null;
  private onStreamEvent: (event: any) => void;

  constructor(options: { id: string; backend: AcpBackend; cliPath?: string; workingDir?: string; onStreamEvent: (event: any) => void }) {
    this.onStreamEvent = options.onStreamEvent;

    // åˆ›å»ºè¿æ¥
    this.connection = new AcpConnection();

    // æ³¨å†Œå›è°ƒ
    this.connection.onSessionUpdate = this.handleSessionUpdate.bind(this);
    this.connection.onPermissionRequest = this.handlePermissionRequest.bind(this);
    this.connection.onEndTurn = this.handleEndTurn.bind(this);
    this.connection.onFileOperation = this.handleFileOperation.bind(this);
  }

  /**
   * å¯åŠ¨ Agent
   */
  async start() {
    await this.connection.connect(this.backend, this.cliPath, this.workingDir);

    // åˆ›å»ºä¼šè¯
    const response = await this.connection.newSession(this.workingDir);
    this.sessionId = response.result.sessionId;
  }

  /**
   * å‘é€æ¶ˆæ¯
   */
  async sendMessage(data: { content: string; files?: string[]; msg_id?: string }): Promise<AcpResult> {
    try {
      await this.connection.sendPrompt(data.content);
      return { success: true };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  /**
   * å¤„ç†ä¼šè¯æ›´æ–°
   */
  private handleSessionUpdate(update: AcpSessionUpdate) {
    // ä½¿ç”¨é€‚é…å™¨è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
    const event = AcpAdapter.convertUpdate(update);

    // è§¦å‘æµäº‹ä»¶
    this.onStreamEvent(event);
  }

  /**
   * å¤„ç†æƒé™è¯·æ±‚
   */
  private async handlePermissionRequest(params: AcpPermissionRequest): Promise<{ optionId: string }> {
    // åˆ›å»ºæƒé™æ¶ˆæ¯ï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·
    const permissionMessage = {
      role: 'permission_request',
      options: params.options,
      toolCall: params.toolCall,
      confirmKey: generateConfirmKey(),
    };

    this.onStreamEvent(permissionMessage);

    // ç­‰å¾…ç”¨æˆ·å“åº”ï¼ˆé€šè¿‡ confirmMessage æ–¹æ³•ï¼‰
    return new Promise((resolve) => {
      this.pendingPermissionResolve = resolve;
    });
  }

  /**
   * ç¡®è®¤æƒé™ï¼ˆç”¨æˆ·é€‰æ‹©åè°ƒç”¨ï¼‰
   */
  async confirmMessage(data: { confirmKey: string; msg_id: string; callId: string }) {
    // å°†ç”¨æˆ·é€‰æ‹©çš„ optionId è¿”å›ç»™ Agent
    if (this.pendingPermissionResolve) {
      this.pendingPermissionResolve({ optionId: data.confirmKey });
      this.pendingPermissionResolve = null;
    }
  }
}
```

### 6.3 å‰ç«¯ UI é›†æˆ

**èŠå¤©ç•Œé¢ï¼š**

```typescript
// src/renderer/pages/conversation/acp/AcpChat.tsx

const AcpChat: React.FC<{
  conversation_id: string;
  workspace?: string;
  backend: AcpBackend;
}> = ({ conversation_id, workspace, backend }) => {
  return (
    <ConversationProvider value={{
      conversationId: conversation_id,
      workspace,
      type: 'acp',
    }}>
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <MessageList />

      {/* è¾“å…¥æ¡† */}
      <AcpSendBox conversation_id={conversation_id} backend={backend} />
    </ConversationProvider>
  );
};
```

**å·¥å…·è°ƒç”¨ UIï¼š**

```typescript
// src/renderer/messages/acp/MessageAcpToolCall.tsx

const MessageAcpToolCall: React.FC<{ toolCall: ToolCallUpdate }> = ({ toolCall }) => {
  return (
    <div className="tool-call">
      {/* å·¥å…·å›¾æ ‡ */}
      <div className="tool-icon">
        {toolCall.kind === 'read' && <FileIcon />}
        {toolCall.kind === 'edit' && <EditIcon />}
        {toolCall.kind === 'execute' && <TerminalIcon />}
      </div>

      {/* å·¥å…·æ ‡é¢˜ */}
      <div className="tool-title">{toolCall.title}</div>

      {/* çŠ¶æ€æŒ‡ç¤ºå™¨ */}
      <div className={`tool-status tool-status-${toolCall.status}`}>
        {toolCall.status === 'pending' && <ClockIcon />}
        {toolCall.status === 'in_progress' && <SpinnerIcon />}
        {toolCall.status === 'completed' && <CheckIcon />}
        {toolCall.status === 'failed' && <XIcon />}
      </div>

      {/* æ–‡ä»¶è·¯å¾„ */}
      {toolCall.locations && (
        <div className="tool-locations">
          {toolCall.locations.map(loc => (
            <span key={loc.path}>{loc.path}</span>
          ))}
        </div>
      )}

      {/* Diff å†…å®¹ */}
      {toolCall.content && toolCall.content[0]?.type === 'diff' && (
        <DiffViewer diff={toolCall.content[0].diff} />
      )}
    </div>
  );
};
```

### 6.4 IPC Bridge é›†æˆ

```typescript
// src/process/bridge/acpConversationBridge.ts

export function initAcpConversationBridge() {
  // ç¡®è®¤æƒé™
  ipcBridge.acpConversation.confirmMessage.provider(async ({ confirmKey, msg_id, conversation_id, callId }) => {
    const task = WorkerManage.getTaskById(conversation_id) as AcpAgentManager;
    await task.confirmMessage({ confirmKey, msg_id, callId });
    return { success: true };
  });

  // æ£€æµ‹å¯ç”¨çš„ Agent
  ipcBridge.acpConversation.getAvailableAgents.provider(async () => {
    const agents = acpDetector.getDetectedAgents();
    return { success: true, data: agents };
  });

  // æ£€æµ‹ CLI è·¯å¾„
  ipcBridge.acpConversation.detectCliPath.provider(async ({ backend }) => {
    const agents = acpDetector.getDetectedAgents();
    const agent = agents.find((a) => a.backend === backend);
    return {
      success: !!agent?.cliPath,
      data: { path: agent?.cliPath },
    };
  });
}
```

---

## ä¸ƒã€ACP vs MCPï¼šä¸¤ä¸ªåè®®çš„å¯¹æ¯”ä¸äº’è¡¥

### 7.1 æ ¸å¿ƒåŒºåˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ACP vs MCP å¯¹æ¯”                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              ACP (Agent Client Protocol)      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ä½œç”¨ï¼šç¼–è¾‘å™¨ â†â†’ AI Agent                      â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šä»£ç ç¼–è¾‘ã€é‡æ„ã€è°ƒè¯•                     â”‚ â”‚
â”‚  â”‚ é€šä¿¡ï¼šåŒå‘ï¼ˆè¯·æ±‚/å“åº” + é€šçŸ¥ï¼‰                 â”‚ â”‚
â”‚  â”‚ ä¼ è¾“ï¼šstdio (æœ¬åœ°è¿›ç¨‹é€šä¿¡)                    â”‚ â”‚
â”‚  â”‚ åˆ›å»ºè€…ï¼šZed Industries                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚           MCP (Model Context Protocol)        â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ä½œç”¨ï¼šAI æ¨¡å‹ â†â†’ å·¥å…·/èµ„æº                    â”‚ â”‚
â”‚  â”‚ åœºæ™¯ï¼šæ•°æ®åº“æŸ¥è¯¢ã€APIè°ƒç”¨ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œ        â”‚ â”‚
â”‚  â”‚ é€šä¿¡ï¼šä¸»è¦æ˜¯å•å‘ï¼ˆæ¨¡å‹è°ƒç”¨å·¥å…·ï¼‰               â”‚ â”‚
â”‚  â”‚ ä¼ è¾“ï¼šstdio / HTTP with SSE                  â”‚ â”‚
â”‚  â”‚ åˆ›å»ºè€…ï¼šAnthropic                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 è¯¦ç»†å¯¹æ¯”è¡¨

| ç»´åº¦         | ACP                        | MCP                          |
| ------------ | -------------------------- | ---------------------------- |
| **å®Œæ•´åç§°** | Agent Client Protocol      | Model Context Protocol       |
| **ä¸»è¦ç”¨é€”** | ç¼–è¾‘å™¨ä¸ AI ç¼–ç åŠ©æ‰‹çš„é€šä¿¡ | AI æ¨¡å‹ä¸å¤–éƒ¨å·¥å…·/èµ„æºçš„é€šä¿¡ |
| **é€šä¿¡æ–¹å‘** | åŒå‘ï¼ˆç¼–è¾‘å™¨ â†” Agentï¼‰    | ä¸»è¦å•å‘ï¼ˆModel â†’ Toolsï¼‰    |
| **åè®®åŸºç¡€** | JSON-RPC 2.0 over stdio    | JSON-RPC 2.0 over stdio/HTTP |
| **ä¼ è¾“æ–¹å¼** | stdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰      | stdio / HTTP with SSE        |
| **ç”Ÿå‘½å‘¨æœŸ** | ç¼–è¾‘å™¨å¯åŠ¨ Agent å­è¿›ç¨‹    | Host å¯åŠ¨ MCP Server         |
| **çŠ¶æ€ç®¡ç†** | æœ‰çŠ¶æ€ï¼ˆä¼šè¯æŒä¹…åŒ–ï¼‰       | æœ‰çŠ¶æ€ï¼ˆè¿æ¥ç”Ÿå‘½å‘¨æœŸï¼‰       |
| **æƒé™æ§åˆ¶** | å†…ç½®æƒé™è¯·æ±‚æœºåˆ¶           | ä¾èµ– Host å®ç°               |
| **å…¸å‹åœºæ™¯** | ä»£ç ç”Ÿæˆã€é‡æ„ã€è°ƒè¯•       | æ•°æ®åº“æŸ¥è¯¢ã€API è°ƒç”¨         |
| **ä½œè€…**     | Zed Industries             | Anthropic                    |
| **å‘å¸ƒæ—¶é—´** | 2025 å¹´                    | 2024 å¹´                      |
| **å¼€æºåè®®** | Apache 2.0                 | MIT                          |

### 7.3 åä½œå…³ç³»

ACP å’Œ MCP ä¸æ˜¯ç«äº‰å…³ç³»ï¼Œè€Œæ˜¯**äº’è¡¥å…³ç³»**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ACP + MCP å®Œæ•´æ¶æ„å›¾                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ Editor   â”‚                                      â”‚
â”‚  â”‚  (Zed)   â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚       â”‚                                             â”‚
â”‚       â”‚ ACP (Agent Client Protocol)                â”‚
â”‚       â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚   AI Agent           â”‚                          â”‚
â”‚  â”‚  (Claude Code)       â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚       â”‚                                             â”‚
â”‚       â”‚ MCP (Model Context Protocol)               â”‚
â”‚       â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚   MCP Servers        â”‚                          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
â”‚  â”‚ â€¢ Database Server    â”‚                          â”‚
â”‚  â”‚ â€¢ File System        â”‚                          â”‚
â”‚  â”‚ â€¢ Git Server         â”‚                          â”‚
â”‚  â”‚ â€¢ Web Fetch          â”‚                          â”‚
â”‚  â”‚ â€¢ Memory/Knowledge   â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®é™…å·¥ä½œæµç¨‹ï¼š**

1. **ç”¨æˆ·** åœ¨ Zed ç¼–è¾‘å™¨ä¸­è¾“å…¥ï¼š"å¸®æˆ‘é‡æ„è¿™ä¸ªå‡½æ•°ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°æ•°æ®åº“"
2. **Zed** é€šè¿‡ **ACP** å°†æ¶ˆæ¯å‘é€ç»™ **Claude Code Agent**
3. **Claude** åˆ†æä»£ç ï¼Œç”Ÿæˆé‡æ„åçš„ä»£ç 
4. **Claude** é€šè¿‡ **MCP** è°ƒç”¨ **Database Server** å°†ç»“æœä¿å­˜
5. **Claude** é€šè¿‡ **ACP** å°†ç»“æœè¿”å›ç»™ **Zed**
6. **Zed** åœ¨ç¼–è¾‘å™¨ä¸­æ˜¾ç¤ºé‡æ„åçš„ä»£ç å’Œæ‰§è¡Œç»“æœ

### 7.4 åœ¨ AionUi ä¸­çš„é›†æˆ

AionUi é¡¹ç›®åŒæ—¶æ”¯æŒ ACP å’Œ MCPï¼š

```typescript
// src/agent/acp/AcpConnection.ts

async newSession(cwd: string): Promise<AcpResponse> {
  return await this.sendRequest('session/new', {
    cwd,
    // å¯ä»¥åœ¨åˆ›å»º ACP ä¼šè¯æ—¶é…ç½® MCP æœåŠ¡å™¨
    mcpServers: [
      {
        name: 'database',
        command: 'node',
        args: ['./mcp-servers/database-server.js'],
      },
      {
        name: 'git',
        command: 'node',
        args: ['./mcp-servers/git-server.js'],
      },
    ],
  });
}
```

è¿™æ ·ï¼ŒClaude Code Agent å°±å¯ä»¥åŒæ—¶ï¼š

- é€šè¿‡ **ACP** ä¸ç¼–è¾‘å™¨é€šä¿¡
- é€šè¿‡ **MCP** è®¿é—®æ•°æ®åº“ã€Git ç­‰å·¥å…·

---

## å…«ã€ç”Ÿæ€ç³»ç»Ÿä¸å®é™…åº”ç”¨

### 8.1 æ”¯æŒ ACP çš„ç¼–è¾‘å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ACP ç¼–è¾‘å™¨ç”Ÿæ€                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  âœ… Zed (å®˜æ–¹æ”¯æŒï¼ŒåŸç”Ÿé›†æˆ)            â”‚
â”‚  âœ… Neovim (ç¤¾åŒºæ’ä»¶)                  â”‚
â”‚  âœ… JetBrains IDEs (å®˜æ–¹åˆä½œ)          â”‚
â”‚  âœ… Marimo (æ•°æ®ç§‘å­¦ç¬”è®°æœ¬)             â”‚
â”‚  ğŸ”„ VS Code (è®¡åˆ’ä¸­)                   â”‚
â”‚  ğŸ”„ Emacs (ç¤¾åŒºå¼€å‘ä¸­)                 â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Zed çš„ ACP é…ç½®ç¤ºä¾‹ï¼š**

```json
// ~/.config/zed/settings.json
{
  "agents": {
    "claude": {
      "command": "claude-code",
      "args": [],
      "env": {
        "ANTHROPIC_API_KEY": "sk-ant-..."
      }
    },
    "gemini": {
      "command": "gemini-cli",
      "args": ["--model", "gemini-1.5-pro"]
    },
    "codex": {
      "command": "codex",
      "args": ["--api-key", "sk-..."]
    }
  }
}
```

### 8.2 æ”¯æŒ ACP çš„ AI Agent

| Agent           | å‚å•†      | æ¨¡å‹              | ç‰¹æ€§                         |
| --------------- | --------- | ----------------- | ---------------------------- |
| **Claude Code** | Anthropic | Claude 3.5 Sonnet | é•¿ä¸Šä¸‹æ–‡ã€æ€ç»´é“¾ã€ä»£ç ç†è§£å¼º |
| **Gemini CLI**  | Google    | Gemini 1.5 Pro    | å¤šæ¨¡æ€ã€å¿«é€Ÿå“åº”             |
| **Codex CLI**   | OpenAI    | GPT-4             | å¹¿æ³›çš„ç¼–ç¨‹è¯­è¨€æ”¯æŒ           |
| **Qwen Code**   | é˜¿é‡Œäº‘    | Qwen Coder        | ä¸­æ–‡ç¼–ç¨‹ã€æœ¬åœ°åŒ–             |
| **goose**       | Block     | å¤šæ¨¡å‹æ”¯æŒ        | å¼€æºã€å¯å®šåˆ¶                 |

### 8.3 å®é™…åº”ç”¨åœºæ™¯

#### åœºæ™¯ 1ï¼šä»£ç é‡æ„

**ç”¨æˆ·è¾“å…¥ï¼š**

> "å°†è¿™ä¸ªç»„ä»¶ä» Class ç»„ä»¶é‡æ„ä¸º Function ç»„ä»¶ï¼Œä½¿ç”¨ Hooks"

**ACP å·¥ä½œæµç¨‹ï¼š**

```
1. [Agent Message] "æˆ‘ä¼šå¸®ä½ é‡æ„è¿™ä¸ªç»„ä»¶..."

2. [Tool Call - Read]
   è¯»å– src/components/UserList.tsx

3. [Agent Thought]
   "è¿™æ˜¯ä¸€ä¸ª Class ç»„ä»¶ï¼Œæœ‰ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å’Œä¸€ä¸ªçŠ¶æ€..."

4. [Tool Call - Edit]
   ç”Ÿæˆé‡æ„åçš„ä»£ç ï¼ˆä½¿ç”¨ useStateã€useEffectï¼‰

5. [Permission Request]
   "æ˜¯å¦å…è®¸ä¿®æ”¹ UserList.tsx?"

6. [User] ç‚¹å‡»"å…è®¸"

7. [Tool Call - Execute]
   è¿è¡Œ `npm run lint` æ£€æŸ¥è¯­æ³•

8. [Agent Message]
   "é‡æ„å®Œæˆï¼ä»£ç å·²é€šè¿‡ lint æ£€æŸ¥ã€‚"
```

#### åœºæ™¯ 2ï¼šBug ä¿®å¤

**ç”¨æˆ·è¾“å…¥ï¼š**

> "ä¿®å¤è¿™ä¸ª TypeScript ç±»å‹é”™è¯¯"

**ACP å·¥ä½œæµç¨‹ï¼š**

```
1. [Tool Call - Read]
   è¯»å–å½“å‰æ–‡ä»¶

2. [Agent Thought]
   "ç±»å‹é”™è¯¯æ˜¯å› ä¸ºå‡½æ•°è¿”å›å€¼ç±»å‹ä¸åŒ¹é…..."

3. [Plan Update]
   - [âœ“] åˆ†æç±»å‹é”™è¯¯
   - [â†’] ä¿®æ”¹å‡½æ•°ç­¾å
   - [ ] æ·»åŠ ç±»å‹æ³¨è§£
   - [ ] è¿è¡Œ tsc æ£€æŸ¥

4. [Tool Call - Edit]
   ä¿®æ”¹å‡½æ•°ç±»å‹å®šä¹‰

5. [Tool Call - Execute]
   è¿è¡Œ `tsc --noEmit`

6. [Agent Message]
   "ç±»å‹é”™è¯¯å·²ä¿®å¤ï¼TypeScript ç¼–è¯‘é€šè¿‡ã€‚"
```

#### åœºæ™¯ 3ï¼šé›†æˆ MCP çš„å¤æ‚åœºæ™¯

**ç”¨æˆ·è¾“å…¥ï¼š**

> "ä»æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨ï¼Œç”Ÿæˆä¸€ä¸ª React è¡¨æ ¼ç»„ä»¶"

**ACP + MCP åä½œæµç¨‹ï¼š**

```
1. [ACP] Agent æ”¶åˆ°è¯·æ±‚

2. [MCP] Agent è°ƒç”¨ Database Server
   Tool: query_users()

3. [MCP] Database Server è¿”å›æ•°æ®
   Result: [{id: 1, name: "Alice"}, ...]

4. [ACP] Agent æ€è€ƒå¦‚ä½•ç”Ÿæˆç»„ä»¶

5. [ACP] Agent åˆ›å»ºæ–°æ–‡ä»¶
   Tool Call: write_file("UserTable.tsx")

6. [ACP] Agent ç”Ÿæˆç»„ä»¶ä»£ç 
   åŸºäºæ•°æ®åº“ç»“æ„ç”Ÿæˆ TypeScript ç±»å‹

7. [ACP] Agent è¿è¡Œæµ‹è¯•
   Tool Call: execute("npm test UserTable")

8. [ACP] Agent è¿”å›ç»“æœ
   "ç»„ä»¶å·²åˆ›å»ºï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
```

---

## ä¹ã€æœ€ä½³å®è·µä¸å®‰å…¨è€ƒé‡

### 9.1 å®ç° ACP Agent çš„æœ€ä½³å®è·µ

#### 1. æ—¥å¿—å¤„ç†

**âŒ é”™è¯¯åšæ³•ï¼š**

```typescript
// ä¸è¦å†™å…¥ stdoutï¼
console.log('Agent is processing...');
```

**âœ… æ­£ç¡®åšæ³•ï¼š**

```typescript
// ä½¿ç”¨ stderr æˆ–æ–‡ä»¶æ—¥å¿—
import fs from 'fs';

const logFile = fs.createWriteStream('/tmp/agent.log');

function log(message: string) {
  logFile.write(`[${new Date().toISOString()}] ${message}\n`);
}

log('Agent is processing...');
```

**åŸå› ï¼š** ACP ä½¿ç”¨ stdout ä¼ è¾“ JSON-RPC æ¶ˆæ¯ï¼Œä»»ä½•é JSON è¾“å‡ºéƒ½ä¼šç ´ååè®®ã€‚

#### 2. é”™è¯¯å¤„ç†

```typescript
try {
  await executeToolCall(toolCall);
} catch (error) {
  // è¿”å›æ ‡å‡†é”™è¯¯æ ¼å¼
  return {
    jsonrpc: '2.0',
    id: requestId,
    error: {
      code: -32603,
      message: error.message,
      data: {
        stack: error.stack,
      },
    },
  };
}
```

#### 3. è¶…æ—¶ç®¡ç†

```typescript
const TOOL_CALL_TIMEOUT = 30000; // 30 ç§’

async function executeToolCallWithTimeout(toolCall: ToolCall) {
  return Promise.race([executeToolCall(toolCall), new Promise((_, reject) => setTimeout(() => reject(new Error('Tool call timeout')), TOOL_CALL_TIMEOUT))]);
}
```

#### 4. æµå¼å“åº”

å¯¹äºé•¿æ—¶é—´çš„æ“ä½œï¼Œä½¿ç”¨æµå¼æ›´æ–°ï¼š

```typescript
async function generateCode(prompt: string) {
  // å‘é€è¿›åº¦æ›´æ–°
  sendNotification('session/update', {
    update: {
      sessionUpdate: 'agent_thought_chunk',
      content: { type: 'text', text: 'æ­£åœ¨åˆ†æéœ€æ±‚...' },
    },
  });

  // ç”Ÿæˆä»£ç 
  const code = await llm.generate(prompt);

  // å‘é€ä»£ç å—
  sendNotification('session/update', {
    update: {
      sessionUpdate: 'agent_message_chunk',
      content: { type: 'text', text: code },
    },
  });
}
```

### 9.2 å®‰å…¨è€ƒé‡

#### 1. æ–‡ä»¶ç³»ç»Ÿè®¿é—®æ§åˆ¶

```typescript
// å®šä¹‰å…è®¸çš„å·¥ä½œç›®å½•
const ALLOWED_WORKSPACE = process.env.WORKSPACE_DIR;

function validateFilePath(path: string): boolean {
  const resolvedPath = path.resolve(path);

  // æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å…è®¸çš„å·¥ä½œç›®å½•å†…
  if (!resolvedPath.startsWith(ALLOWED_WORKSPACE)) {
    throw new Error('Access denied: path outside workspace');
  }

  // æ£€æŸ¥æ˜¯å¦è®¿é—®æ•æ„Ÿæ–‡ä»¶
  const sensitivePatterns = ['.env', '.git/config', 'id_rsa'];
  if (sensitivePatterns.some((pattern) => resolvedPath.includes(pattern))) {
    throw new Error('Access denied: sensitive file');
  }

  return true;
}
```

#### 2. å‘½ä»¤æ‰§è¡Œå®‰å…¨

```typescript
// ç™½åå•æœºåˆ¶
const ALLOWED_COMMANDS = ['npm test', 'npm run lint', 'tsc --noEmit', 'git status'];

function validateCommand(command: string): boolean {
  return ALLOWED_COMMANDS.some((allowed) => command.startsWith(allowed));
}

async function executeCommand(command: string) {
  if (!validateCommand(command)) {
    throw new Error('Command not allowed');
  }

  // æ‰§è¡Œå‘½ä»¤
  return execAsync(command, {
    timeout: 30000,
    cwd: WORKSPACE_DIR,
  });
}
```

#### 3. æƒé™è¯·æ±‚å®ç°

```typescript
async function requestPermission(toolCall: ToolCall): Promise<boolean> {
  // å‘é€æƒé™è¯·æ±‚
  sendNotification('session/request_permission', {
    sessionId: currentSessionId,
    options: [
      { optionId: 'allow_once', name: 'ä»…æ­¤ä¸€æ¬¡å…è®¸', kind: 'allow_once' },
      { optionId: 'allow_always', name: 'å§‹ç»ˆå…è®¸', kind: 'allow_always' },
      { optionId: 'reject', name: 'æ‹’ç»', kind: 'reject_once' },
    ],
    toolCall,
  });

  // ç­‰å¾…ç”¨æˆ·å“åº”
  const response = await waitForPermissionResponse();

  // ç¼“å­˜æƒé™å†³ç­–
  if (response.kind === 'allow_always') {
    permissionCache.set(toolCall.kind, true);
  } else if (response.kind === 'reject_always') {
    permissionCache.set(toolCall.kind, false);
  }

  return response.kind.startsWith('allow');
}
```

#### 4. æ•æ„Ÿä¿¡æ¯å¤„ç†

```typescript
// è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
function sanitizeContent(content: string): string {
  // ç§»é™¤ API å¯†é’¥
  content = content.replace(/sk-[a-zA-Z0-9]{48}/g, '***API_KEY***');

  // ç§»é™¤å¯†ç 
  content = content.replace(/password\s*=\s*['"][^'"]+['"]/gi, 'password=***');

  // ç§»é™¤ Token
  content = content.replace(/Bearer\s+[a-zA-Z0-9._-]+/g, 'Bearer ***');

  return content;
}
```

### 9.3 æ€§èƒ½ä¼˜åŒ–

#### 1. æ‰¹é‡æ“ä½œ

```typescript
// æ‰¹é‡è¯»å–æ–‡ä»¶
async function readMultipleFiles(paths: string[]): Promise<Map<string, string>> {
  const results = new Map();

  await Promise.all(
    paths.map(async (path) => {
      const content = await fs.readFile(path, 'utf-8');
      results.set(path, content);
    })
  );

  return results;
}
```

#### 2. å¢é‡æ›´æ–°

```typescript
// åªå‘é€å˜åŒ–çš„å†…å®¹
let lastContent = '';

function sendDiffUpdate(newContent: string) {
  const diff = computeDiff(lastContent, newContent);

  if (diff) {
    sendNotification('session/update', {
      update: {
        sessionUpdate: 'agent_message_chunk',
        content: { type: 'diff', diff },
      },
    });
  }

  lastContent = newContent;
}
```

#### 3. ç¼“å­˜æœºåˆ¶

```typescript
// ç¼“å­˜æ–‡ä»¶å†…å®¹
const fileCache = new LRU<string, string>({
  max: 100,
  maxAge: 5 * 60 * 1000, // 5 åˆ†é’Ÿ
});

async function readFileWithCache(path: string): Promise<string> {
  const cached = fileCache.get(path);
  if (cached) return cached;

  const content = await fs.readFile(path, 'utf-8');
  fileCache.set(path, content);

  return content;
}
```

---

## åã€æœªæ¥å±•æœ›

### 10.1 åè®®æ¼”è¿›æ–¹å‘

#### 1. æ›´ä¸°å¯Œçš„å†…å®¹ç±»å‹

```typescript
// æœªæ¥å¯èƒ½æ”¯æŒçš„å†…å®¹ç±»å‹
interface FutureContent {
  type: 'text' | 'image' | 'video' | 'audio' | 'diagram' | '3d-model';
  // ...
}

// ç¤ºä¾‹ï¼šAgent ç”Ÿæˆæ¶æ„å›¾
{
  sessionUpdate: 'agent_message_chunk',
  content: {
    type: 'diagram',
    format: 'mermaid',
    data: `
      graph TD
        A[Client] -->|HTTP| B[Server]
        B --> C[Database]
    `
  }
}
```

#### 2. å¤š Agent åä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¤š Agent åä½œæ¶æ„                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Editor                                 â”‚
â”‚    â”‚                                    â”‚
â”‚    â”œâ”€â”€â–¶ Code Agent (è´Ÿè´£ä»£ç ç”Ÿæˆ)       â”‚
â”‚    â”‚                                    â”‚
â”‚    â”œâ”€â”€â–¶ Test Agent (è´Ÿè´£æµ‹è¯•)          â”‚
â”‚    â”‚                                    â”‚
â”‚    â”œâ”€â”€â–¶ Review Agent (è´Ÿè´£ä»£ç å®¡æŸ¥)     â”‚
â”‚    â”‚                                    â”‚
â”‚    â””â”€â”€â–¶ Deploy Agent (è´Ÿè´£éƒ¨ç½²)        â”‚
â”‚                                         â”‚
â”‚  Agent ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡å’Œåä½œ            â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. å¢å¼ºçš„ä¸Šä¸‹æ–‡ç®¡ç†

```typescript
// æœªæ¥çš„ä¼šè¯ä¸Šä¸‹æ–‡
interface EnhancedSessionContext {
  // é¡¹ç›®å…ƒæ•°æ®
  project: {
    name: string;
    language: string[];
    framework: string[];
    dependencies: Record<string, string>;
  };

  // ä»£ç å›¾è°±
  codeGraph: {
    files: FileNode[];
    imports: ImportEdge[];
    exports: ExportEdge[];
  };

  // å†å²æ“ä½œ
  history: Operation[];

  // ç”¨æˆ·åå¥½
  preferences: {
    codingStyle: string;
    testFramework: string;
    // ...
  };
}
```

### 10.2 ç”Ÿæ€ç³»ç»Ÿå»ºè®¾

#### 1. ACP Agent å¸‚åœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ACP Agent å¸‚åœº                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  â€¢ å®˜æ–¹ Agentï¼ˆClaudeã€Geminiã€Codexï¼‰ â”‚
â”‚  â€¢ ç¤¾åŒº Agentï¼ˆå¼€æºã€å®šåˆ¶åŒ–ï¼‰           â”‚
â”‚  â€¢ ä¼ä¸š Agentï¼ˆç§æœ‰éƒ¨ç½²ã€å®šåˆ¶æ¨¡å‹ï¼‰     â”‚
â”‚                                        â”‚
â”‚  ç”¨æˆ·å¯ä»¥ï¼š                             â”‚
â”‚  - æµè§ˆå’Œæœç´¢ Agent                    â”‚
â”‚  - æŸ¥çœ‹è¯„åˆ†å’Œè¯„è®º                       â”‚
â”‚  - ä¸€é”®å®‰è£…å’Œé…ç½®                       â”‚
â”‚  - åˆ†äº«è‡ªå·±çš„ Agent                    â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. æ ‡å‡†åŒ–çš„ Agent èƒ½åŠ›å£°æ˜

```json
// agent-manifest.json
{
  "name": "my-custom-agent",
  "version": "1.0.0",
  "description": "A custom coding agent for Rust projects",
  "author": "Your Name",
  "capabilities": {
    "languages": ["rust", "toml"],
    "frameworks": ["tokio", "actix"],
    "tools": {
      "code_generation": true,
      "refactoring": true,
      "testing": true,
      "debugging": false
    }
  },
  "requirements": {
    "model": "gpt-4",
    "apiKey": "required",
    "minEditorVersion": "0.158.0"
  }
}
```

#### 3. è·¨ç¼–è¾‘å™¨åŒæ­¥

```typescript
// æœªæ¥çš„è·¨ç¼–è¾‘å™¨é…ç½®åŒæ­¥
interface AgentConfig {
  agents: {
    [name: string]: {
      command: string;
      args: string[];
      env: Record<string, string>;
      settings: any;
    };
  };
  preferences: {
    defaultAgent: string;
    autoStart: boolean;
    // ...
  };
}

// åŒæ­¥åˆ°äº‘ç«¯
await syncConfigToCloud(config);

// åœ¨å¦ä¸€å°è®¾å¤‡ä¸Š
const config = await loadConfigFromCloud();
```

### 10.3 ä¸å…¶ä»–æ ‡å‡†çš„é›†æˆ

#### 1. ä¸ LSP çš„æ·±åº¦é›†æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ACP + LSP ååŒå·¥ä½œ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  Editor                                â”‚
â”‚    â”‚                                   â”‚
â”‚    â”œâ”€â”€â–¶ LSP (æä¾›è¯­è¨€æ™ºèƒ½)             â”‚
â”‚    â”‚     - è‡ªåŠ¨è¡¥å…¨                    â”‚
â”‚    â”‚     - ç±»å‹æ£€æŸ¥                    â”‚
â”‚    â”‚     - é‡æ„å»ºè®®                    â”‚
â”‚    â”‚                                   â”‚
â”‚    â””â”€â”€â–¶ ACP (æä¾› AI èƒ½åŠ›)            â”‚
â”‚          - ç†è§£ LSP çš„è¯Šæ–­ä¿¡æ¯         â”‚
â”‚          - ç”Ÿæˆç¬¦åˆé¡¹ç›®è§„èŒƒçš„ä»£ç       â”‚
â”‚          - è‡ªåŠ¨ä¿®å¤ LSP æŠ¥å‘Šçš„é”™è¯¯     â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. ä¸ Debug Adapter Protocol (DAP) é›†æˆ

```typescript
// Agent å¯ä»¥ç†è§£è°ƒè¯•ä¿¡æ¯
{
  sessionUpdate: 'debug_analysis',
  breakpoint: {
    file: 'src/index.ts',
    line: 42,
    variables: {
      user: { id: 123, name: 'Alice' },
      error: new Error('Invalid token')
    }
  },
  suggestion: "é”™è¯¯æ˜¯å› ä¸º token å·²è¿‡æœŸï¼Œå»ºè®®æ·»åŠ  token åˆ·æ–°é€»è¾‘"
}
```

### 10.4 AI åŸç”Ÿç¼–ç¨‹èŒƒå¼

ACP æ­£åœ¨æ¨åŠ¨ä¸€ç§æ–°çš„ç¼–ç¨‹èŒƒå¼ï¼š**AI åŸç”Ÿç¼–ç¨‹ï¼ˆAI-Native Programmingï¼‰**ã€‚

```
ä¼ ç»Ÿç¼–ç¨‹ï¼š
  äººç±» â†’ æ‰‹å†™ä»£ç  â†’ ç¼–è¯‘å™¨ â†’ å¯æ‰§è¡Œç¨‹åº

AI è¾…åŠ©ç¼–ç¨‹ï¼ˆç°åœ¨ï¼‰ï¼š
  äººç±» â†’ AI ç”Ÿæˆä»£ç ç‰‡æ®µ â†’ äººç±»ä¿®æ”¹ â†’ ç¼–è¯‘å™¨ â†’ å¯æ‰§è¡Œç¨‹åº

AI åŸç”Ÿç¼–ç¨‹ï¼ˆæœªæ¥ï¼‰ï¼š
  äººç±»æè¿°éœ€æ±‚ â†’ AI Agent ç†è§£ â†’ AI è®¾è®¡æ¶æ„ â†’ AI å®ç° â†’ AI æµ‹è¯• â†’ AI éƒ¨ç½²
  â†‘                                                                    â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äººç±»å®¡æŸ¥å’ŒæŒ‡å¯¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹å¾ï¼š**

1. **å£°æ˜å¼ç¼–ç¨‹**ï¼šäººç±»åªéœ€æè¿°"è¦ä»€ä¹ˆ"ï¼Œè€Œä¸æ˜¯"æ€ä¹ˆåš"
2. **æŒç»­å¯¹è¯**ï¼šç¼–ç¨‹å˜æˆä¸ AI çš„æŒç»­å¯¹è¯è¿‡ç¨‹
3. **å¤šå±‚æŠ½è±¡**ï¼šä»éœ€æ±‚ â†’ æ¶æ„ â†’ å®ç° â†’ ä¼˜åŒ–ï¼Œæ¯å±‚éƒ½æœ‰ AI è¾…åŠ©
4. **è‡ªåŠ¨åŒ–æµç¨‹**ï¼šæµ‹è¯•ã€éƒ¨ç½²ã€ç›‘æ§éƒ½ç”± AI è‡ªåŠ¨åŒ–

---

## åä¸€ã€æ€»ç»“

### 11.1 ACP çš„æ ¸å¿ƒä»·å€¼

âœ… **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„åè®®è§„èŒƒï¼Œæ¶ˆé™¤ç¼–è¾‘å™¨ä¸ Agent çš„äº’æ“ä½œå£å’

âœ… **å¼€æ”¾æ€§**ï¼šå¼€æºåè®®ï¼Œä»»ä½•äººéƒ½å¯ä»¥å®ç°å’Œæ‰©å±•

âœ… **éšç§ä¼˜å…ˆ**ï¼šæœ¬åœ°é€šä¿¡ï¼Œä¸ç»è¿‡ç¬¬ä¸‰æ–¹æœåŠ¡å™¨

âœ… **å¯ç»„åˆæ€§**ï¼šä¸ MCP ç­‰åè®®ååŒå·¥ä½œï¼Œæ„å»ºå®Œæ•´çš„ AI ç”Ÿæ€

âœ… **æ˜“ç”¨æ€§**ï¼šåŸºäºæˆç†Ÿçš„ JSON-RPC 2.0ï¼Œç®€å•é«˜æ•ˆ

### 11.2 é€‚ç”¨åœºæ™¯

- **ä»£ç ç¼–è¾‘å™¨å¼€å‘è€…**ï¼šå¸Œæœ›é›†æˆå¤šä¸ª AI ç¼–ç åŠ©æ‰‹
- **AI Agent å¼€å‘è€…**ï¼šå¸Œæœ›è®©è‡ªå·±çš„ Agent è¢«æ›´å¤šç¼–è¾‘å™¨æ”¯æŒ
- **ä¼ä¸šå¼€å‘å›¢é˜Ÿ**ï¼šéœ€è¦åœ¨ç»Ÿä¸€çš„ç¼–è¾‘å™¨ç¯å¢ƒä¸­ä½¿ç”¨ä¸åŒçš„ AI å·¥å…·
- **å¼€æºç¤¾åŒº**ï¼šæ„å»ºå¼€æ”¾ã€åä½œçš„ AI è¾…åŠ©ç¼–ç¨‹ç”Ÿæ€

### 11.3 å¼€å§‹ä½¿ç”¨ ACP

#### 1. ä½œä¸ºç¼–è¾‘å™¨å¼€å‘è€…

```bash
# å®‰è£… ACP SDK
npm install @agentclientprotocol/sdk

# å‚è€ƒ Zed çš„å®ç°
git clone https://github.com/zed-industries/zed
```

#### 2. ä½œä¸º Agent å¼€å‘è€…

```bash
# é€‰æ‹©ä½ å–œæ¬¢çš„è¯­è¨€ SDK
npm install @agentclientprotocol/sdk       # TypeScript
pip install agent-client-protocol          # Python
cargo add agent-client-protocol            # Rust
```

#### 3. ä½œä¸ºç”¨æˆ·

```bash
# ä¸‹è½½æ”¯æŒ ACP çš„ç¼–è¾‘å™¨
# Zed
curl https://zed.dev/install.sh | sh

# é…ç½®ä½ å–œæ¬¢çš„ Agent
zed --config agents.claude.command="claude-code"
```

### 11.4 å­¦ä¹ èµ„æº

- **å®˜æ–¹ç½‘ç«™**ï¼š[agentclientprotocol.com](https://agentclientprotocol.com/)
- **GitHub ä»“åº“**ï¼š[github.com/agentclientprotocol/agent-client-protocol](https://github.com/agentclientprotocol/agent-client-protocol)
- **åè®®è§„èŒƒ**ï¼š[Schema JSON](https://github.com/agentclientprotocol/agent-client-protocol/blob/main/schema/schema.json)
- **ç¤¾åŒºè®¨è®º**ï¼š[GitHub Discussions](https://github.com/agentclientprotocol/agent-client-protocol/discussions)

---

## é™„å½•ï¼šACP ä¸ MCP åè®®å¯¹æ¯”é€ŸæŸ¥è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ACP vs MCP é€ŸæŸ¥è¡¨                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç‰¹æ€§           â”‚   ACP             â”‚   MCP             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®Œæ•´åç§°         â”‚ Agent Client      â”‚ Model Context     â”‚
â”‚                  â”‚ Protocol          â”‚ Protocol          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸»è¦ä½œç”¨         â”‚ ç¼–è¾‘å™¨ â†” AI Agent â”‚ AI Model â†” Tools  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åè®®åŸºç¡€         â”‚ JSON-RPC 2.0      â”‚ JSON-RPC 2.0      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¼ è¾“æ–¹å¼         â”‚ stdio             â”‚ stdio / HTTP+SSE  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€šä¿¡æ–¹å‘         â”‚ åŒå‘              â”‚ ä¸»è¦å•å‘          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”Ÿå‘½å‘¨æœŸç®¡ç†     â”‚ ç¼–è¾‘å™¨æ§åˆ¶        â”‚ Host æ§åˆ¶         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æƒé™æ§åˆ¶         â”‚ å†…ç½®æœºåˆ¶          â”‚ ä¾èµ– Host         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æµå¼å“åº”         â”‚ æ”¯æŒ              â”‚ æ”¯æŒ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½œè€…             â”‚ Zed Industries    â”‚ Anthropic         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼€æºåè®®         â”‚ Apache 2.0        â”‚ MIT               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å‘å¸ƒæ—¶é—´         â”‚ 2025              â”‚ 2024              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…¸å‹åœºæ™¯         â”‚ ä»£ç ç”Ÿæˆã€é‡æ„    â”‚ æ•°æ®åº“ã€API è°ƒç”¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**å…³äºæœ¬æ–‡**

æœ¬æ–‡ç»“åˆäº†ï¼š

- MCP å®˜æ–¹æ–‡æ¡£å’Œç¤¾åŒºå®è·µ
- ACP å®˜æ–¹è§„èŒƒå’Œ Zed å®ç°
- AionUi é¡¹ç›®çš„å®é™…ä»£ç 
- è¡Œä¸šæœ€ä½³å®è·µå’Œæœªæ¥è¶‹åŠ¿

å¸Œæœ›èƒ½å¸®åŠ©ä½ æ·±å…¥ç†è§£ ACP åè®®ï¼Œå¹¶åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨ã€‚

**ä½œè€…**ï¼šåŸºäºæ˜é‡‘æ–‡ç« ã€ŠMCP æ·±åº¦è§£æã€‹ã€ACP å®˜æ–¹æ–‡æ¡£ã€ä»¥åŠ AionUi å¼€æºé¡¹ç›®ç»¼åˆæ•´ç†

**æ›´æ–°æ—¥æœŸ**ï¼š2025 å¹´

---

**ç›¸å…³é˜…è¯»**

- [MCP å®˜æ–¹æ–‡æ¡£](https://modelcontextprotocol.io)
- [ACP å®˜æ–¹ç½‘ç«™](https://agentclientprotocol.com/)
- [Zed ç¼–è¾‘å™¨ ACP é›†æˆ](https://zed.dev/acp)
- [AionUi å¼€æºé¡¹ç›®](https://github.com/iOfficeAI/AionUi)
